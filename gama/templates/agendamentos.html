<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Documentos - GAMA</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilo.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gerenciar_editais.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon-b.ico') }}">

    <style>
        /* Estilos da tabela de agendamentos */
        .agendamentos-table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        .agendamentos-table th,
        .agendamentos-table td { padding: 12px 10px; text-align: left; vertical-align: middle; word-wrap: break-word; border-bottom: 1px solid #e5e7eb; }
        .agendamentos-table tr:last-child td { border-bottom: none; }
        .agendamentos-table th:nth-child(1), .agendamentos-table td:nth-child(1) { width: 12%; } /* Data */
        .agendamentos-table th:nth-child(2), .agendamentos-table td:nth-child(2) { width: 7%; }  /* Hora */
        .agendamentos-table th:nth-child(3), .agendamentos-table td:nth-child(3) { width: 28%; } /* Candidato */
        .agendamentos-table th:nth-child(4), .agendamentos-table td:nth-child(4) { width: 15%; } /* Agendado por */
        .agendamentos-table th:nth-child(5), .agendamentos-table td:nth-child(5) { width: 12%; } /* Status */
        .agendamentos-table th:nth-child(6), .agendamentos-table td:nth-child(6) { width: 26%; } /* Ações */
        .agendamentos-table .actions { white-space: nowrap; }

        /* Estilos para a nova tabela de Candidatos */
        .candidatos-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
        .candidatos-table th,
        .candidatos-table td { padding: 12px 10px; text-align: left; vertical-align: middle; border-bottom: 1px solid #e5e7eb; }
        .candidatos-table th:nth-child(1) { width: 35%; } /* Nome */
        .candidatos-table th:nth-child(2) { width: 15%; text-align: center; } /* Contatado */
        .candidatos-table th:nth-child(3) { width: 25%; } /* Entrega Doc */
        .candidatos-table th:nth-child(4) { width: 25%; } /* Perícia */
        
        .candidatos-table td:nth-child(2) { text-align: center; }

        /* Botão de Contatado (liga/desliga) */
        .btn-toggle { display: inline-flex; align-items: center; justify-content: center; padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s ease; }
        .btn-toggle[data-contatado="true"] { background-color: #dcfce7; border-color: #16a34a; color: #15803d; }
        .btn-toggle[data-contatado="false"] { background-color: #f3f4f6; color: #4b5563; }
        .btn-toggle[data-contatado="true"]:hover { background-color: #bbf7d0; }
        .btn-toggle[data-contatado="false"]:hover { background-color: #e5e7eb; }
        .btn-toggle .fas { margin-right: 6px; }

        /* Botão "Agendar" pequeno */
        .btn-agendar { background-color: #3b82f6; color: white; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer; }
        .btn-agendar:hover { background-color: #2563eb; }

        /* Status de Agendamento */
        .status-agendado { font-weight: 500; color: #d97706; }
        .status-entregue { font-weight: 500; color: #16a34a; }

        /* Outros estilos */
        .sub-section-title { margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #ddd; font-size: 1.1rem; color: #333; }
        .actions .btn-sm.btn-success { display: inline-flex; align-items: center; background-color: #2563EB; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .actions .btn-sm.btn-success:hover { background-color: #4338CA; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .actions .btn-sm.btn-success:active { transform: translateY(0); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .fa-user-md { margin-right: 6px; }
        .actions .btn-sm.btn-concluir { display: inline-flex; align-items: center; background-color: var(--primary); color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .actions .btn-sm.btn-concluir:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .fa-check-square { margin-right: 6px; }
    </style>
    </head>
<body>
    <div class="dashboard">
        <header class="dashboard-header">
            <nav class="dashboard-nav container">
                <h1 class="dashboard-title">GAMA</h1>
                <div class="dashboard-user">
                    <span>{{ nome }}</span>
                    {% if session.get('tipo') == 'administrador' %}
                        <a href="{{ url_for('admin.painel_admin') }}" class="btn btn-secondary">Voltar ao Painel</a>
                    {% else %}
                        <a href="{{ url_for('usuarios.painel_usuario') }}" class="btn btn-secondary">Voltar ao Painel</a>
                    {% endif %}
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-primary">Sair</a>
                </div>
            </nav>
        </header>

        <main class="dashboard-content container">
            <div class="section-header">
                <h2 class="page-title">Controle de Documentos</h2>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% for edital in editais %}
            <div class="edital-card">
                <div class="edital-header" onclick="toggleContent('body-edital-{{ edital[0] }}', this)">
                    <div class="edital-info">
                        <strong>{{ edital[1] }}</strong>
                    </div>
                    </div>
                
                <div class="edital-body" id="body-edital-{{ edital[0] }}">
                    
                    <h4 class="sub-section-title">Candidatos Nomeados</h4>
                    {% set lista_candidatos = dados_pagina[edital[0]].candidatos %}
                    {% if lista_candidatos %}
                        <table class="candidatos-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Contatado</th>
                                    <th>Entrega de Documentos</th>
                                    <th>Perícia Médica</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in lista_candidatos %}
                                <tr>
                                    <td>{{ c.nome }}</td>
                                    <td>
                                        <button class="btn-toggle" data-contatado="{{ 'true' if c.contatado else 'false' }}" data-id="{{ c.id }}" onclick="toggleContatado(this)">
                                            {% if c.contatado %}
                                                <i class="fas fa-check"></i> Sim
                                            {% else %}
                                                <i class="fas fa-times"></i> Não
                                            {% endif %}
                                        </button>
                                    </td>
                                    <td>
                                        {% if c.status_doc == 'agendar' %}
                                            <button class="btn-agendar" onclick="openAgendamentoModal({{ edital[0] }}, '{{ c.nome }}')">
                                                Agendar
                                            </button>
                                        {% elif c.status_doc == 'agendado' %}<span class="status-agendado">Agendado</span>
                                        {% elif c.status_doc == 'entregue' %}<span class="status-entregue">Entregue</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if c.status_pericia == 'agendar' %}
                                            {% if c.status_doc == 'entregue' %}
                                                <button class="btn-agendar" onclick="openPericiaModal({{ edital[0] }}, '{{ c.nome }}')">
                                                    Agendar Perícia
                                                </button>
                                            {% else %}
                                                <span style="color: #9ca3af;">(Aguardando Docs)</span>
                                            {% endif %}
                                        {% elif c.status_pericia == 'agendado' %}<span class="status-agendado">Agendada</span>
                                        {% elif c.status_pericia == 'concluida' %}<span class="status-entregue">Concluída</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="empty-state" style="margin-bottom: 2rem;"><p>Nenhum candidato com situação "Nomeado" encontrado para este edital.</p></div>
                    {% endif %}
                    
                    
                    <h4 class="sub-section-title">Agendamentos: Entregas de Documentos</h4>
                    {% set lista_documentos = dados_pagina[edital[0]].agend_docs %}
                    {% if lista_documentos %}
                        <table class="edital-table agendamentos-table">
                            <thead>
                                <tr>
                                    <th>Data</th><th>Hora</th><th>Candidato</th><th>Agendado por</th><th>Status</th><th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for agendamento in lista_documentos %}
                                <tr>
                                    <td>{{ agendamento[1]|dateformat_br }}</td>
                                    <td>{{ agendamento[1]|timeformat }}</td>
                                    <td>{{ agendamento[2] }}</td>
                                    <td>{{ agendamento[7] }}</td>
                                    <td>
                                        {% if agendamento[5] == 'concluido' %}<span class="badge-agendamento badge-success">Entregue (OK)</span>
                                        {% else %}<span class="badge-agendamento badge-warning">Agendado</span>{% endif %}
                                    </td>
                                    <td class="actions">
                                        <button class="icon-button" title="Editar Agendamento" data-agendamento='{{ agendamento|tojson }}' onclick="openAgendamentoModal(this)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form action="{{ url_for('usuarios.remover_agendamento', id_agendamento=agendamento[0]) }}" method="POST" onsubmit="return confirm('Tem certeza?');" style="display:inline;">
                                            <button type="submit" class="icon-button" title="Remover Agendamento"><i class="fas fa-trash-alt"></i></button>
                                        </form>
                                        {% if agendamento[5] == 'agendado' %}
                                            <button class="btn-sm btn-success" title="Concluir entrega e agendar perícia" onclick="openPericiaModal({{ edital[0] }}, '{{ agendamento[2] }}', {{ agendamento[0] }})">
                                                <i class="fas fa-user-md"></i> Concluir e Agendar
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="empty-state"><p>Nenhum agendamento de documentos para este edital.</p></div>
                    {% endif %}

                    <h4 class="sub-section-title">Agendamentos: Perícia Médica</h4>
                    {% set lista_pericias = dados_pagina[edital[0]].agend_pericias %}
                    {% if lista_pericias %}
                        <table class="edital-table agendamentos-table">
                            <thead>
                                <tr>
                                    <th>Data</th><th>Hora</th><th>Candidato</th><th>Agendado por</th><th>Status</th><th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for agendamento in lista_pericias %}
                                <tr>
                                    <td>{{ agendamento[1]|dateformat_br }}</td>
                                    <td>{{ agendamento[1]|timeformat }}</td>
                                    <td>{{ agendamento[2] }}</td>
                                    <td>{{ agendamento[7] }}</td>
                                    <td>
                                        {% if agendamento[5] == 'concluido' %}<span class="badge-agendamento badge-success">Realizada</span>
                                        {% else %}<span class="badge-agendamento badge-warning">Agendada</span>{% endif %}
                                    </td>
                                    <td class="actions">
                                        <button class="icon-button" title="Editar Perícia" data-agendamento='{{ agendamento|tojson }}' onclick="openAgendamentoModal(this, 'pericia')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form action="{{ url_for('usuarios.remover_agendamento', id_agendamento=agendamento[0]) }}" method="POST" onsubmit="return confirm('Tem certeza?');" style="display:inline;">
                                            <button type="submit" class="icon-button" title="Remover Perícia"><i class="fas fa-trash-alt"></i></button>
                                        </form>
                                        {% if agendamento[5] == 'agendado' %}
                                            <form action="{{ url_for('usuarios.concluir_pericia', id_agendamento=agendamento[0]) }}" method="POST" style="display:inline; margin-left: 5px;">
                                                <button type="submit" class="btn-sm btn-success" title="Marcar perícia como realizada">
                                                    <i class="fas fa-user-md"></i> Realizada
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="empty-state"><p>Nenhum agendamento de perícia para este edital.</p></div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </main>
    </div>

    <div id="agendamentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Novo Agendamento</h3>
                <button class="icon-button" onclick="closeAgendamentoModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="agendamentoForm" action="{{ url_for('usuarios.criar_agendamento') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="id_edital" id="id_edital_agendamento">
                    <input type="hidden" name="id_agendamento" id="id_agendamento">
                    <input type="hidden" name="tipo_agendamento" id="tipo_agendamento" value="documento">
                    <input type="hidden" name="id_documento_a_concluir" id="id_documento_a_concluir" value="">
                    
                    <div class="form-group">
                        <label for="nome_pessoa">Nome do Candidato</label>
                        <input type="text" id="nome_pessoa" name="nome_pessoa" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data_agendamento">Data</label>
                            <input type="date" id="data_agendamento" name="data_agendamento" required>
                        </div>
                        <div class="form-group">
                            <label for="hora_agendamento">Hora</label>
                            <input type="time" id="hora_agendamento" name="hora_agendamento" required>
                        </div>
                        <div class="form-group">
                            <label for="status_agendamento">Status</label>
                            <select id="status_agendamento" name="status_agendamento" required>
                                <option value="agendado">Agendado</option>
                                <option value="concluido">Entregue (OK)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAgendamentoModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Agendamento</button>
                </div>
            </form>
        </div>
    </div>

<script>
    function toggleContent(elementId, headerElement) {
        const body = document.getElementById(elementId);
        if (body) body.classList.toggle('active');
        if (headerElement) headerElement.classList.toggle('active');
    }
    
    // Esta função foi REMOVIDA na última versão, pois não é mais necessária
    // function toggleGroup(headerElement) { ... }

    const agendamentoModal = document.getElementById('agendamentoModal');
    const agendamentoForm = document.getElementById('agendamentoForm');
    const modalTitle = document.getElementById('modalTitle');

    function openAgendamentoModal(elemento_ou_id_edital, nome_candidato = null, tipo = 'documento') {
        agendamentoForm.reset();
        document.getElementById('id_documento_a_concluir').value = ''; 
        
        const inputNome = document.getElementById('nome_pessoa');
        const statusSelect = document.getElementById('status_agendamento');
        const statusLabel = document.querySelector('label[for="status_agendamento"]');

        statusSelect.style.display = 'block';
        statusLabel.style.display = 'block';

        if (typeof elemento_ou_id_edital === 'object' && elemento_ou_id_edital.hasAttribute('data-agendamento')) {
            const agendamento_data = JSON.parse(elemento_ou_id_edital.dataset.agendamento);
            modalTitle.innerText = tipo === 'pericia' ? 'Editar Perícia Médica' : 'Editar Agendamento';
            
            const id_agendamento = agendamento_data[0];
            const data_hora_str = agendamento_data[1];
            const nome = agendamento_data[2];
            const status = agendamento_data[5];

            agendamentoForm.action = `/usuario/agendamento/editar/${id_agendamento}`;
            
            document.getElementById('id_agendamento').value = id_agendamento;
            inputNome.value = nome;
            inputNome.readOnly = false; 
            document.getElementById('data_agendamento').value = data_hora_str.substring(0, 10);
            document.getElementById('hora_agendamento').value = data_hora_str.substring(11, 16);
            statusSelect.value = status;
        } 
        else {
            const id_edital = elemento_ou_id_edital;
            modalTitle.innerText = 'Novo Ag. de Documentos';
            agendamentoForm.action = "{{ url_for('usuarios.criar_agendamento') }}";
            document.getElementById('id_edital_agendamento').value = id_edital;
            document.getElementById('id_agendamento').value = '';
            document.getElementById('tipo_agendamento').value = 'documento';
            statusSelect.value = 'agendado';

            if (nome_candidato) {
                inputNome.value = nome_candidato;
                inputNome.readOnly = true; 
            } else {
                inputNome.value = '';
                inputNome.readOnly = false;
            }
        }

        agendamentoModal.classList.add('active');
    }

    function openPericiaModal(id_edital, nome_candidato, id_documento_a_concluir = null) {
        agendamentoForm.reset();
        
        modalTitle.innerText = 'Agendar Perícia Médica';
        agendamentoForm.action = "{{ url_for('usuarios.criar_agendamento') }}";
        
        document.getElementById('id_edital_agendamento').value = id_edital;
        document.getElementById('id_agendamento').value = '';
        document.getElementById('tipo_agendamento').value = 'pericia';
        document.getElementById('nome_pessoa').value = nome_candidato;
        document.getElementById('nome_pessoa').readOnly = true;
        
        document.getElementById('id_documento_a_concluir').value = id_documento_a_concluir || '';

        document.getElementById('status_agendamento').value = 'agendado';
        document.getElementById('status_agendamento').style.display = 'none';
        document.querySelector('label[for="status_agendamento"]').style.display = 'none';

        agendamentoModal.classList.add('active');
    }

    function closeAgendamentoModal() {
        agendamentoModal.classList.remove('active');
    }

    window.onclick = function(event) {
        if (event.target == agendamentoModal) {
            closeAgendamentoModal();
        }
    }
    
    async function toggleContatado(button) {
        const id_candidato = button.dataset.id;
        const estado_atual = button.dataset.contatado === 'true';
        const novo_status = !estado_atual; 

        try {
            const response = await fetch("{{ url_for('usuarios.toggle_contatado') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_candidato: id_candidato,
                    status: novo_status
                })
            });

            const data = await response.json();

            if (data.success) {
                // ======================================================
                // CORREÇÃO DO BUG AQUI: Garante que o dataset seja 'true' ou 'false'
                // ======================================================
                button.dataset.contatado = data.novo_status ? 'true' : 'false';
                
                if (data.novo_status) {
                    button.innerHTML = '<i class="fas fa-check"></i> Sim';
                } else {
                    button.innerHTML = '<i class="fas fa-times"></i> Não';
                }
            } else {
                alert('Erro ao atualizar o status: ' + data.message);
            }
        } catch (error) {
            console.error('Erro no fetch:', error);
            alert('Erro de conexão ao tentar atualizar o status.');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            setTimeout(function() {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.style.display = 'none';
                }, 500);
            }, 5000);
        });
    });
</script>
</body>
</html>