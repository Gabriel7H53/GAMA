<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emissão de Termo de Posse - GAMA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/edital.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon-b.ico') }}">
</head>
<body>
    <div class="dashboard">
        <header class="dashboard-header">
            <nav class="dashboard-nav container">
                <h1 class="dashboard-title">GAMA</h1>
                <div class="dashboard-user">
                    <span>{{ nome }}</span>
                    {% if session.get('tipo') == 'administrador' %}
                        <a href="{{ url_for('admin.painel_admin') }}" class="btn btn-primary">Painel Admin</a>
                    {% else %}
                        <a href="{{ url_for('usuarios.painel_usuario') }}" class="btn btn-primary">Meu Painel</a>
                    {% endif %}
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-primary">Sair</a>
                </div>
            </nav>
        </header>

        <main class="dashboard-content container">
            <div class="section-header">
                <h2 class="page-title">Emissão de Termo de Posse</h2>
                <p class="config-subtitle" style="margin: 0;">Gera o <strong>Termo de Posse</strong> e o <strong>Termo de Apresentação</strong> (em .zip)</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}{% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}{% endif %}
            {% endwith %}

            <form id="form-lote" action="{{ url_for('certificado.gerar_certificado_lote') }}" method="POST">
                <input type="hidden" name="reitor" id="lote_reitor">
                <input type="hidden" name="local" id="lote_local">
                <div id="inputs-container"></div> 
            </form>

            {% for edital in editais %}
            <div class="edital-card">
                <div class="edital-header js-toggle-trigger" data-target="body-cert-edital-{{ edital[0] }}">
                    <div class="edital-info">
                        <strong>{{ edital[1] }}</strong>
                    </div>
                    <div class="actions">
                        <button type="button" class="btn btn-primary" style="padding: 0.5rem 1rem;" onclick="event.stopPropagation(); selecionarTodosEdital(this)">
                            Selecionar Todos
                        </button>
                    </div>
                </div>
                <div class="edital-body" id="body-cert-edital-{{ edital[0] }}">
                    {% set cargos_do_edital = candidatos_por_edital_agrupado.get(edital[0], {}) %}
                    {% if cargos_do_edital %}
                        {% for cargo_nome, lista_de_candidatos in cargos_do_edital.items() %}
                        <div class="cargo-group">
                            <div class="cargo-header js-toggle-trigger" data-target="body-cert-cargo-{{ edital[0] }}-{{ loop.index }}">
                                <h4 class="cargo-title">{{ cargo_nome }} 
                                    {% if lista_de_candidatos[0].padrao_vencimento %}
                                        (Nível {{ lista_de_candidatos[0].padrao_vencimento }})
                                    {% endif %}
                                </h4>
                            </div>
                            <div class="cargo-body" id="body-cert-cargo-{{ edital[0] }}-{{ loop.index }}">
                                <table class="edital-table">
                                    <thead>
                                        <tr>
                                            <th class="checkbox-col">
                                                <input type="checkbox" class="checkbox-custom" onchange="toggleCargoCheckbox(this)">
                                            </th>
                                            <th>Candidato</th>
                                            <th>Inscrição</th>
                                            <th>Situação</th>
                                            <th style="width: 15%;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for candidato in lista_de_candidatos %}
                                        <tr>
                                            <td class="checkbox-col">
                                                <input type="checkbox" 
                                                       class="checkbox-custom candidato-select" 
                                                       value="{{ candidato.id_candidato }}"
                                                       data-nome="{{ candidato.nome }}"
                                                       data-info='{{ candidato|tojson }}'
                                                       onchange="atualizarBarraFlutuante()">
                                            </td>
                                            <td>
                                                {{ candidato.nome }}
                                                {# Lógica para verificar dados faltantes #}
                                                {% set faltantes = [] %}
                                                {% if not candidato.data_posse %}{% set _ = faltantes.append('Data de Posse') %}{% endif %}
                                                {% if not candidato.portaria %}{% set _ = faltantes.append('Portaria') %}{% endif %}
                                                {% if not candidato.lotacao %}{% set _ = faltantes.append('Lotação') %}{% endif %}
                                                {% if not candidato.cod_vaga %}{% set _ = faltantes.append('Código de Vaga') %}{% endif %}
                                                
                                                {# Se houver itens na lista de faltantes, exibe o ícone #}
                                                {% if faltantes %}
                                                    <i class="fas fa-exclamation-circle" 
                                                        style="color: #dc2626; margin-left: 8px; cursor: help;" 
                                                        title="Dados faltantes: {{ faltantes|join(', ') }}">
                                                    </i>
                                                {% endif %}
                                            </td>
                                            <td>{{ candidato.numero_inscricao }}</td>
                                            <td>
                                                {% if candidato.situacao == 'empossado' %}
                                                    <span class="badge badge-success">Empossado</span>
                                                {% else %}
                                                    <span class="badge badge-warning">Nomeado</span>
                                                {% endif %}
                                            </td>
                                            <td class="actions">
                                                <button type="button" class="btn btn-primary" style="padding: 0.5rem 1rem;" 
                                                        data-candidato='{{ candidato|tojson }}'
                                                        onclick="openConfirmacaoIndividual(this)">
                                                    Emitir
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state" style="margin: 1.5rem;"><p>Nenhum candidato (nomeado ou empossado) encontrado.</p></div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </main>
    </div>

    <div class="bulk-action-bar" id="bulkActionBar">
        <span><span id="selectedCount" class="count-badge">0</span> candidatos selecionados</span>
        <button class="btn btn-primary" onclick="openConfirmacaoLote()">
            <i class="fas fa-file-archive"></i> Gerar Selecionados (Lote)
        </button>
        <button class="btn btn-secondary" onclick="limparSelecao()" style="padding: 5px 10px;">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div id="confirmacaoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmacaoModalTitle">Confirmar Emissão</h3>
                <button class="icon-button" onclick="closeConfirmacaoModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p id="texto-confirmacao-intro">Você está prestes a gerar documentos para:</p>
                
                <h4 id="destaque-confirmacao" style="margin: 1rem 0; font-size: 1.2rem; text-align: center;"></h4>
                
                <div id="detalhes-individual" style="display: block;">
                     <p>Dados do candidato:</p>
                     <ul>
                        <li><strong>Data de Posse:</strong> <span id="data_posse_confirm"></span></li>
                        <li><strong>Portaria:</strong> <span id="portaria_confirm"></span></li>
                        <li><strong>Lotação:</strong> <span id="lotacao_confirm"></span></li>
                        <li><strong>Cód. Vaga:</strong> <span id="cod_vaga_confirm_modal"></span></li>
                     </ul>
                </div>

                <hr style="margin: 1rem 0;">
                <p>Configurações Globais que serão usadas:</p>
                <ul>
                    <li><strong>Reitor:</strong> <span class="conf-reitor-display">{{ default_reitor or 'NÃO DEFINIDO' }}</span></li>
                    <li><strong>Local:</strong> <span class="conf-local-display">{{ default_local or 'NÃO DEFINIDO' }}</span></li>
                </ul>
                
                <div id="confirmacao-erro" class="alert alert-error" style="display: none; margin-top: 1rem;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmacaoModal()">Cancelar</button>
                
                <form id="form-individual-submit" method="POST" style="display: none;">
                    <input type="hidden" name="reitor" class="input-reitor">
                    <input type="hidden" name="local" class="input-local">
                </form>

                <button type="button" id="btnConfirmarEmissao" class="btn btn-primary" onclick="submitEmissao()">Gerar Documentos</button>
            </div>
        </div>
    </div>
    
    <script>
    // Valores Padrão do Servidor
    const DEFAULT_REITOR = "{{ default_reitor or '' }}";
    const DEFAULT_LOCAL = "{{ default_local or '' }}";
    let MODO_ATUAL = 'individual'; // 'individual' ou 'lote'

    document.addEventListener('DOMContentLoaded', () => {
        // Collapsible
        document.querySelectorAll('.js-toggle-trigger').forEach(trigger => {
            trigger.addEventListener('click', function(event) {
                event.stopPropagation(); 
                const targetId = this.dataset.target;
                const body = document.getElementById(targetId);
                if (body) {
                    body.classList.toggle('active');
                    this.classList.toggle('active');
                }
            });
        });
        setTimeout(() => {
        document.querySelectorAll('.alert:not(#confirmacao-erro)').forEach(el => el.style.display = 'none');
    }, 5000);
    });

    // --- Lógica de Seleção (Checkboxes) ---
    function atualizarBarraFlutuante() {
        const selecionados = document.querySelectorAll('.candidato-select:checked').length;
        const barra = document.getElementById('bulkActionBar');
        const contador = document.getElementById('selectedCount');
        
        contador.innerText = selecionados;
        
        if (selecionados > 0) {
            barra.classList.add('active');
        } else {
            barra.classList.remove('active');
        }
    }

    function toggleCargoCheckbox(source) {
        // Seleciona/Desseleciona todos na tabela do cargo atual
        const table = source.closest('table');
        const checkboxes = table.querySelectorAll('.candidato-select');
        checkboxes.forEach(cb => cb.checked = source.checked);
        atualizarBarraFlutuante();
    }

    function selecionarTodosEdital(btn) {
        // Acha o container do edital
        const card = btn.closest('.edital-card');
        // Acha todos os checkboxes dentro dele
        const checkboxes = card.querySelectorAll('.candidato-select');
        const checkboxesCargo = card.querySelectorAll('.checkbox-custom:not(.candidato-select)'); // Headers de tabela
        
        // Verifica se tem algum desmarcado para decidir se marca tudo ou desmarca tudo
        let algumDesmarcado = false;
        checkboxes.forEach(cb => { if(!cb.checked) algumDesmarcado = true; });

        checkboxes.forEach(cb => cb.checked = algumDesmarcado);
        checkboxesCargo.forEach(cb => cb.checked = algumDesmarcado);
        
        atualizarBarraFlutuante();
    }

    function limparSelecao() {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        atualizarBarraFlutuante();
    }

    // --- Lógica do Modal ---
    const confirmacaoModal = document.getElementById('confirmacaoModal');
    const btnConfirmar = document.getElementById('btnConfirmarEmissao');
    const msgErro = document.getElementById('confirmacao-erro');

    function checkConfiguracao() {
        if (!DEFAULT_REITOR || !DEFAULT_LOCAL) {
            msgErro.style.display = 'block';
            msgErro.innerHTML = '<strong>Erro:</strong> Reitor ou Local padrão não definidos em "Configurações".';
            btnConfirmar.disabled = true;
            return false;
        }
        return true;
    }

    function openConfirmacaoIndividual(btn) {
        MODO_ATUAL = 'individual';
        const candidato = JSON.parse(btn.dataset.candidato);
        const formIndividual = document.getElementById('form-individual-submit');
        
        // Configura Visual
        document.getElementById('confirmacaoModalTitle').innerText = "Confirmar Emissão Individual";
        document.getElementById('destaque-confirmacao').innerText = candidato.nome;
        document.getElementById('detalhes-individual').style.display = 'block';
        
        // Preenche dados visualização
        document.getElementById('data_posse_confirm').innerText = candidato.data_posse || "PENDENTE";
        document.getElementById('portaria_confirm').innerText = candidato.portaria || "PENDENTE";
        document.getElementById('lotacao_confirm').innerText = candidato.lotacao || "PENDENTE";
        document.getElementById('cod_vaga_confirm_modal').innerText = candidato.cod_vaga || "PENDENTE";

        // Preenche Form Oculto
        formIndividual.action = `/certificados/gerar/individual/${candidato.id_candidato}`;
        formIndividual.querySelector('.input-reitor').value = DEFAULT_REITOR;
        formIndividual.querySelector('.input-local').value = DEFAULT_LOCAL;

        // Validações
        msgErro.style.display = 'none';
        btnConfirmar.disabled = false;
        
        if (!checkConfiguracao()) return confirmacaoModal.classList.add('active');
        
        if (!candidato.data_posse || !candidato.portaria || !candidato.lotacao) {
            msgErro.style.display = 'block';
            msgErro.innerHTML = '<strong>Erro:</strong> Dados do candidato incompletos (Data Posse, Portaria ou Lotação e Cód.Vaga).';
            btnConfirmar.disabled = true;
        }

        confirmacaoModal.classList.add('active');
    }

    function openConfirmacaoLote() {
        MODO_ATUAL = 'lote';
        const checkboxes = document.querySelectorAll('.candidato-select:checked');
        
        document.getElementById('confirmacaoModalTitle').innerText = "Confirmar Emissão em Lote";
        document.getElementById('destaque-confirmacao').innerText = `${checkboxes.length} Candidatos Selecionados`;
        document.getElementById('detalhes-individual').style.display = 'none'; // Esconde detalhes específicos

        // Preenche o Form de Lote
        const container = document.getElementById('inputs-container');
        container.innerHTML = ''; // Limpa anteriores
        let temErroDados = false;

        checkboxes.forEach(cb => {
            // Cria input hidden para cada ID
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'candidatos_ids';
            input.value = cb.value;
            container.appendChild(input);

            // Verificação rápida de integridade (opcional, mas bom para UX)
            const info = JSON.parse(cb.dataset.info);
            if(!info.data_posse || !info.portaria || !info.lotacao || !info.cod_vaga) temErroDados = true;
        });

        document.getElementById('lote_reitor').value = DEFAULT_REITOR;
        document.getElementById('lote_local').value = DEFAULT_LOCAL;

        // Validações
        msgErro.style.display = 'none';
        btnConfirmar.disabled = false;

        if (!checkConfiguracao()) return confirmacaoModal.classList.add('active');

        if (temErroDados) {
            msgErro.style.display = 'block';
            msgErro.innerHTML = '<strong>Aviso:</strong> Alguns candidatos selecionados parecem ter dados incompletos. O sistema tentará gerar para todos, mas ignorará os inválidos.';
            // Não desabilita o botão, permite tentar
        }

        confirmacaoModal.classList.add('active');
    }

    function submitEmissao() {
        if (MODO_ATUAL === 'individual') {
            document.getElementById('form-individual-submit').submit();
        } else {
            document.getElementById('form-lote').submit();
        }
        closeConfirmacaoModal();
    }

    function closeConfirmacaoModal() {
        confirmacaoModal.classList.remove('active');
    }

    window.onclick = function(event) {
        if (event.target == confirmacaoModal) closeConfirmacaoModal();
    }
    </script>

</body>
</html>