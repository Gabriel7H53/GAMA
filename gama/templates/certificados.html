<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emissão de Termo de Posse - GAMA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/edital.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon-b.ico') }}">
</head>
<body>
    <div class="dashboard">
        <header class="dashboard-header">
            <nav class="dashboard-nav container">
                <h1 class="dashboard-title">GAMA</h1>
                <div class="dashboard-user">
                    <span>{{ nome }}</span>
                    {% if session.get('tipo') == 'administrador' %}
                        <a href="{{ url_for('admin.painel_admin') }}" class="btn btn-secondary">Painel Admin</a>
                    {% else %}
                        <a href="{{ url_for('usuarios.painel_usuario') }}" class="btn btn-secondary">Meu Painel</a>
                    {% endif %}
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-primary">Sair</a>
                </div>
            </nav>
        </header>

        <main class="dashboard-content container">
            <div class="section-header">
                <h2 class="page-title">Emissão de Termo de Posse</h2>
                <p class="config-subtitle" style="margin: 0;">Gera o <strong>Termo de Posse</strong> e o <strong>Termo de Apresentação</strong> (em .zip)</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}{% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}{% endif %}
            {% endwith %}

            {% for edital in editais %}
            <div class="edital-card">
                <div class="edital-header js-toggle-trigger" data-target="body-cert-edital-{{ edital[0] }}">
                    <div class="edital-info">
                        <strong>{{ edital[1] }}</strong>
                    </div>
                    <div class="actions">
                        </div>
                </div>
                <div class="edital-body" id="body-cert-edital-{{ edital[0] }}">
                    {% set cargos_do_edital = candidatos_por_edital_agrupado.get(edital[0], {}) %}
                    {% if cargos_do_edital %}
                        {% for cargo_nome, lista_de_candidatos in cargos_do_edital.items() %}
                        <div class="cargo-group">
                            <div class="cargo-header js-toggle-trigger" data-target="body-cert-cargo-{{ edital[0] }}-{{ loop.index }}">
                                <h4 class="cargo-title">{{ cargo_nome }} 
                                    {% if lista_de_candidatos[0].padrao_vencimento %}
                                        (Nível {{ lista_de_candidatos[0].padrao_vencimento }})
                                    {% endif %}
                                </h4>
                            </div>
                            <div class="cargo-body" id="body-cert-cargo-{{ edital[0] }}-{{ loop.index }}">
                                <table class="edital-table">
                                    <thead>
                                        <tr>
                                            <th>Candidato</th>
                                            <th>Inscrição</th>
                                            <th>Situação</th>
                                            <th style="width: 15%;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for candidato in lista_de_candidatos %}
                                        <tr>
                                            <td>{{ candidato.nome }}</td>
                                            <td>{{ candidato.numero_inscricao }}</td>
                                            <td>
                                                {% if candidato.situacao == 'empossado' %}
                                                    <span class="badge badge-success">Empossado</span>
                                                {% else %}
                                                    <span class="badge badge-warning">Nomeado</span>
                                                {% endif %}
                                            </td>
                                            <td class="actions">
                                                <form action="{{ url_for('certificado.gerar_certificado_individual', id_candidato=candidato.id_candidato) }}" method="POST" class="form-emitir-individual">
                                                    <input type="hidden" name="reitor" value="{{ default_reitor or '' }}">
                                                    <input type="hidden" name="local" value="{{ default_local or '' }}">
                                                    
                                                    <button type="button" class="btn btn-primary" style="padding: 0.5rem 1rem;" 
                                                            data-candidato='{{ candidato|tojson }}'
                                                            onclick="openConfirmacaoModal(this)">
                                                        Emitir
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state" style="margin: 1.5rem;"><p>Nenhum candidato (nomeado ou empossado) encontrado para este edital.</p></div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </main>
    </div>

    <div id="confirmacaoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmacaoModalTitle">Confirmar Emissão</h3>
                <button class="icon-button" onclick="closeConfirmacaoModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p>Você está prestes a gerar os documentos (Posse e Apresentação) para:</p>
                <h4 id="nome_candidato_confirm" style="margin: 1rem 0; font-size: 1.2rem; text-align: center;"></h4>
                
                <p>Os documentos serão gerados usando os seguintes dados <strong>já salvos no candidato</strong>:</p>
                <ul>
                    <li><strong>Data de Posse:</strong> <span id="data_posse_confirm"></span></li>
                    <li><strong>Portaria:</strong> <span id="portaria_confirm"></span></li>
                    <li><strong>Lotação/Unidade:</strong> <span id="lotacao_confirm"></span></li>
                    <li><strong>Código da Vaga:</strong> <span id="cod_vaga_confirm"></span></li>
                </ul>
                <hr style="margin: 1rem 0;">
                <p>Os seguintes dados (definidos como padrão) serão usados:</p>
                <ul>
                    <li><strong>Reitor:</strong> <span id="reitor_confirm">{{ default_reitor or 'NÃO DEFINIDO' }}</span></li>
                    <li><strong>Local da Posse:</strong> <span id="local_confirm">{{ default_local or 'NÃO DEFINIDO' }}</span></li>
                </ul>
                
                <div id="confirmacao-erro" class="alert alert-error" style="display: none; margin-top: 1rem;">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmacaoModal()">Cancelar</button>
                <button type="button" id="btnConfirmarEmissao" class="btn btn-primary" onclick="submitFormularioIndividual()">Gerar Documentos</button>
            </div>
        </div>
    </div>
    
    <script>
    // ======================================================
    // ALTERAÇÃO AQUI: Listener de Eventos Simplificado
    // ======================================================
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- Listener para abrir/fechar seções (Edital e Cargo) ---
        document.querySelectorAll('.js-toggle-trigger').forEach(trigger => {
            trigger.addEventListener('click', function(event) {
                // Impede que o clique no header do cargo feche o card do edital
                event.stopPropagation(); 
                
                const targetId = this.dataset.target;
                const body = document.getElementById(targetId);
                if (body) {
                    body.classList.toggle('active');
                    this.classList.toggle('active'); // Adiciona/remove 'active' do header também
                }
            });
        });

        // --- Listener para o botão "Emitir Lote" REMOVIDO ---

        // --- Auto-fechar Alertas (Flash Messages) ---
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            setTimeout(function() {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(function() {
                    alert.style.display = 'none';
                }, 500);
            }, 5000);
        });
    });
    // ======================================================
    // FIM DA ALTERAÇÃO
    // ======================================================

    // --- JAVASCRIPT MODAL DE CONFIRMAÇÃO INDIVIDUAL ---
    const confirmacaoModal = document.getElementById('confirmacaoModal');
    let formParaSubmeter = null; 

    function openConfirmacaoModal(button) {
        formParaSubmeter = button.closest('.form-emitir-individual');
        const candidato = JSON.parse(button.dataset.candidato);
        
        let podeGerar = true;
        let erroBase = `
            <strong>Erro:</strong> Não é possível gerar documentos. 
            Por favor, vá à tela de "Gerenciamento de Editais" e preencha os seguintes dados do candidato:
        `;
        let errosDetalhados = [];

        document.getElementById('nome_candidato_confirm').innerText = candidato.nome;
        
        const dataPosse = candidato.data_posse || "PENDENTE";
        document.getElementById('data_posse_confirm').innerText = dataPosse;
        if (dataPosse === "PENDENTE") {
            podeGerar = false;
            errosDetalhados.push("Data da Posse");
        }
        
        const portaria = candidato.portaria || "PENDENTE";
        document.getElementById('portaria_confirm').innerText = portaria;
        if (portaria === "PENDENTE") {
            podeGerar = false;
            errosDetalhados.push("Portaria");
        }
        
        const lotacao = candidato.lotacao || "PENDENTE";
        document.getElementById('lotacao_confirm').innerText = lotacao;
        if (lotacao === "PENDENTE") {
            podeGerar = false;
            errosDetalhados.push("Lotação/Unidade");
        }
        
        document.getElementById('cod_vaga_confirm').innerText = candidato.cod_vaga || "Nenhum";
        
        const reitor = document.getElementById('reitor_confirm').innerText;
        const local = document.getElementById('local_confirm').innerText;
        
        if (reitor === 'NÃO DEFINIDO' || local === 'NÃO DEFINIDO') {
            podeGerar = false;
            erroBase = `
                <strong>Erro:</strong> Faltam dados de Configuração. 
                Por favor, vá em "Configurações" e defina um Reitor e um Local como Padrão.
            `;
            errosDetalhados = []; 
        }

        const btnConfirmar = document.getElementById('btnConfirmarEmissao');
        const msgErro = document.getElementById('confirmacao-erro');
        
        if (podeGerar) {
            msgErro.style.display = 'none';
            btnConfirmar.disabled = false;
        } else {
            if(errosDetalhados.length > 0) {
                 msgErro.innerHTML = erroBase + " <strong>(" + errosDetalhados.join(', ') + ")</strong>";
            } else {
                msgErro.innerHTML = erroBase;
            }
            msgErro.style.display = 'block';
            btnConfirmar.disabled = true;
        }
        
        confirmacaoModal.classList.add('active');
    }

    function closeConfirmacaoModal() {
        confirmacaoModal.classList.remove('active');
        formParaSubmeter = null; 
    }

    function submitFormularioIndividual() {
        if (formParaSubmeter) {
            formParaSubmeter.submit();
        }
        closeConfirmacaoModal();
    }
    
    // ======================================================
    // JAVASCRIPT DO MODAL DE LOTE REMOVIDO
    // ======================================================
    // const loteSelecionadosModal = ...
    // function abrirModalLote(...) { ... }
    // function openLoteSelecionadosModal(...) { ... }
    // function closeLoteSelecionadosModal(...) { ... }
    // checkboxSelecionarTodosLote.addEventListener(...)
    // ======================================================

    // Fechar os modais se o usuário clicar fora deles
    window.onclick = function(event) {
        if (event.target == confirmacaoModal) {
            closeConfirmacaoModal();
        }
        // Listener para o modal de lote removido
    }
</script>

</body>
</html>